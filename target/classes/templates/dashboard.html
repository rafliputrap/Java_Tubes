<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Resep</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .card-img-top { object-fit: cover; height: 200px; }
    </style>
</head>
<body>
<div class="container py-4">
    <h2 class="mb-4">Dashboard Resep Masakan</h2>
    <div class="mb-4">
        <form id="searchForm" class="row g-2">
            <div class="col-auto">
                <input type="text" class="form-control" id="searchInput" placeholder="Cari resep atau bahan...">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Cari</button>
            </div>
        </form>
    </div>
    <div class="mb-4">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">Tambah Resep</button>
    </div>
    <h5>Resep Terbaru</h5>
    <div id="latestRecipes" class="row g-3 mb-4"></div>
    <h5>Semua Resep</h5>
    <div id="allRecipes" class="row g-3"></div>
</div>

<!-- Modal Tambah Resep -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addModalLabel">Tambah Resep</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addRecipeForm">
          <div class="mb-2">
            <input type="text" class="form-control" name="title" placeholder="Judul" required>
          </div>
          <div class="mb-2">
            <textarea class="form-control" name="description" placeholder="Deskripsi" required></textarea>
          </div>
          <div class="mb-2">
            <textarea class="form-control" name="ingredients" placeholder="Bahan-bahan" required></textarea>
          </div>
          <div class="mb-2">
            <textarea class="form-control" name="steps" placeholder="Langkah-langkah" required></textarea>
          </div>
          <div class="mb-2">
            <input type="text" class="form-control" name="imageUrl" placeholder="URL Foto (opsional)">
          </div>
          <div class="mb-2">
            <input type="file" class="form-control" id="uploadImageInput">
            <button type="button" class="btn btn-secondary mt-1 w-100" id="uploadBtn">Upload Foto</button>
            <div id="uploadImageResult" class="small text-success"></div>
          </div>
          <button type="submit" class="btn btn-success w-100">Simpan</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Helper render card
function renderRecipeCard(recipe) {
  return `<div class='col-md-4'><div class='card h-100'>` +
    (recipe.imageUrl ? `<img src='${recipe.imageUrl}' class='card-img-top' alt='${recipe.title}'>` : "") +
    `<div class='card-body'><h5 class='card-title'>${recipe.title}</h5><p class='card-text'>${recipe.description}</p><p><b>Bahan:</b> ${recipe.ingredients}</p><p><b>Langkah:</b> ${recipe.steps}</p></div></div></div>`;
}

// Load all recipes
function loadAllRecipes() {
  fetch('/resep').then(r=>r.json()).then(data => {
    document.getElementById('allRecipes').innerHTML = data.map(renderRecipeCard).join('');
  });
}
// Load latest recipes
function loadLatestRecipes() {
  fetch('/resep/latest').then(r=>r.json()).then(data => {
    document.getElementById('latestRecipes').innerHTML = data.map(renderRecipeCard).join('');
  });
}
// Search recipes
const searchForm = document.getElementById('searchForm');
searchForm.onsubmit = function(e) {
  e.preventDefault();
  const q = document.getElementById('searchInput').value;
  if (!q) { loadAllRecipes(); return; }
  fetch('/resep/search?q=' + encodeURIComponent(q)).then(r=>r.json()).then(data => {
    document.getElementById('allRecipes').innerHTML = data.map(renderRecipeCard).join('');
  });
};
// Add recipe
const addRecipeForm = document.getElementById('addRecipeForm');
addRecipeForm.onsubmit = function(e) {
  e.preventDefault();
  const formData = new FormData(addRecipeForm);
  const obj = {};
  formData.forEach((v,k)=>obj[k]=v);
  fetch('/resep', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  }).then(r=>r.json()).then(() => {
    loadAllRecipes();
    loadLatestRecipes();
    addRecipeForm.reset();
    var modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
    modal.hide();
  });
};
// Upload image
const uploadBtn = document.getElementById('uploadBtn');
const uploadImageInput = document.getElementById('uploadImageInput');
const uploadImageResult = document.getElementById('uploadImageResult');
uploadBtn.onclick = function() {
  if (!uploadImageInput.files[0]) { uploadImageResult.textContent = 'Pilih file gambar!'; return; }
  const formData = new FormData();
  formData.append('file', uploadImageInput.files[0]);
  fetch('/resep/upload', { method: 'POST', body: formData })
    .then(r => r.text())
    .then(url => {
      uploadImageResult.innerHTML = 'URL: <a href="' + url + '" target="_blank">' + url + '</a>';
      // Set ke input imageUrl otomatis
      document.querySelector('input[name="imageUrl"]').value = url;
    });
};
// Initial load
loadAllRecipes();
loadLatestRecipes();
</script>
</body>
</html>
